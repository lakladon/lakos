name: Build and Release

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate Next Version
        id: version
        run: |
          existing_tags=$(git tag -l "v*" 2>/dev/null || echo "")

          if [ -z "$existing_tags" ]; then
            new_version="v0.1.0"
          else
            latest_version=$(echo "$existing_tags" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n 1)

            if [ -z "$latest_version" ]; then
              new_version="v0.1.0"
            else
              version="${latest_version#v}"
              IFS='.' read -r major minor patch <<< "$version"
              patch=$((patch + 1))
              new_version="v${major}.${minor}.${patch}"

              while git rev-parse "$new_version" >/dev/null 2>&1; do
                echo "Tag $new_version already exists, increasing patch version..."
                patch=$((patch + 1))
                new_version="v${major}.${minor}.${patch}"
              done
            fi
          fi

          echo "Next version: $new_version"
          echo "version=$new_version" >> "$GITHUB_OUTPUT"

      - name: Create Git Tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          tag_name="${{ steps.version.outputs.version }}"
          echo "Creating tag: $tag_name"
          git tag "$tag_name"
          git push origin "$tag_name"

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y binutils gcc nasm grub-common xorriso mtools
          sudo ln -s /usr/bin/gcc /usr/bin/i686-elf-gcc
          sudo ln -s /usr/bin/ld /usr/bin/i686-elf-ld

      - name: Build Kernel and ISO
        run: make clean iso

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "Lakos OS ${{ steps.version.outputs.version }}"
          body: |
            ## Lakos OS ${{ steps.version.outputs.version }}

            ### Сборка информации
            - **Версия:** ${{ steps.version.outputs.version }}
            - **Дата сборки:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            - **Коммит:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            - **ID запуска:** ${{ github.run_id }}
            - **Номер сборки:** ${{ github.run_number }}

            ### Изменения
            ${{ github.event.head_commit.message }}

            ### Файлы
            - `lakos.bin` — бинарный файл ядра
            - `lakos.iso` — загрузочный ISO образ
          files: |
            lakos.bin
            lakos.iso
            modules.tar
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}