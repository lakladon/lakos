# ARCHITECTURE.md - Обзор архитектуры LakOS

Этот документ описывает архитектуру LakOS - как компоненты системы взаимодействуют между собой и как организовано их взаимодействие.

## 🏗️ Общая архитектура

LakOS следует классической архитектуре монолитного ядра с четким разделением на уровни:

```
┌─────────────────────────────────────────┐
│              Пользовательские           │
│              программы (ELF)             │
├─────────────────────────────────────────┤
│              Shell                      │
├─────────────────────────────────────────┤
│              Ядро LakOS                 │
│  ┌─────────┬─────────┬─────────────────┐│
│  │ Драйверы│ Файловая │   Команды       ││
│  │ (VGA,   │ система  │   ядра          ││
│  │ клавиат.│ (tar-fs)│                 ││
│  └─────────┴─────────┴─────────────────┘│
├─────────────────────────────────────────┤
│             BIOS/Limine                 │
└─────────────────────────────────────────┘
```

## 📊 Компоненты системы

### 1. Загрузчик (boot/)

**Расположение:** `boot/boot.asm`

**Функции:**
- Инициализация процессора в защищенном режиме
- Настройка базовых регистров сегментов
- Передача управления ядру
- Поддержка Multiboot стандарта

**Ключевые особенности:**
- 32-битный защищенный режим
- Прямая загрузка ядра в память
- Минимальная инициализация оборудования

### 2. Ядро (kernel/)

**Расположение:** `kernel/kernel.c`, `kernel/`

**Основные подсистемы:**

#### 2.1 Драйверы (kernel/drivers/)

**VGA драйвер (`kernel/vga.c`)**
- Цветной текстовый вывод
- Управление курсором
- Boot-анимация
- Системная информация

**Клавиатурный драйвер**
- Обработка скан-кодов
- Буфер ввода
- Специальные клавиши (Backspace, Enter, Escape)

**ATA драйвер (`kernel/drivers/ata.c`)**
- Чтение с диска
- Базовый DMA
- Поддержка LBA адресации

**Мышь (`kernel/drivers/mouse.c`)**
- PS/2 протокол
- Координаты и кнопки
- Буфер событий

#### 2.2 Файловая система (kernel/fs/)

**Tar-FS (`kernel/fs/tar.c`)**
- Чтение tar-архивов как файловой системы
- Вшитый в образ modules.tar
- Поддержка каталогов и файлов
- Поиск по имени

#### 2.3 Shell (`kernel/shell.c`)

**Функции:**
- Командный интерпретатор
- История команд
- Автодополнение
- Выполнение ELF-программ
- Перенаправление ввода/вывода

#### 2.4 Команды ядра (`kernel/commands.c`)

**Встроенные команды:**
- `ls`, `cd`, `pwd` - навигация
- `cat`, `echo` - работа с файлами
- `users`, `login` - управление пользователями
- `gui` - запуск графического интерфейса

#### 2.5 GUI (`kernel/gui.c`)

**Примитивный графический интерфейс:**
- Окна и виджеты
- Обработка событий мыши
- Простая графика

### 3. RootFS (rootfs/)

**Расположение:** `rootfs/`

**Содержимое:**
- `/bin/` - пользовательские программы
- `/etc/` - конфигурация
- `/home/` - домашние директории
- Системные файлы

**Особенности:**
- Сжатый tar-архив
- Вшит в загрузочный образ
- Только для чтения

## 🔄 Процесс загрузки

```
1. BIOS → Limine
   ↓
2. Limine → boot.asm (Multiboot1)
   ↓
3. boot.asm → kernel_entry
   ↓
4. kernel_main()
   ├── Инициализация GDT
   ├── Инициализация IDT
   ├── Инициализация VGA
   ├── Загрузка tar-fs
   └── Запуск shell
   ↓
5. Shell → Пользовательский ввод
```

## 📁 Структура памяти

```
0x00000000 ┌─────────────────┐
           │    Нижняя       │
           │    память       │
0x00100000 ├─────────────────┤ ← 1MB
           │     Ядро        │
           │   (lakos.bin)   │
0x00200000 ├─────────────────┤ ← 2MB
           │   RootFS        │
           │ (modules.tar)   │
0x00400000 ├─────────────────┤ ← 4MB
           │   Свободная     │
           │    память       │
           │   (для malloc)  │
0xFFFFFFFF └─────────────────┘
```

## 🔄 Взаимодействие компонентов

### Shell ↔ Команды ядра
```c
// Вызов встроенной команды
int result = cmd_ls(argc, argv);

// Выполнение ELF-программы
int result = execute_elf("/bin/program");
```

### Shell ↔ Файловая система
```c
// Чтение файла
file_t* file = tarfs_open("/etc/config.txt");
char* content = tarfs_read(file);
tarfs_close(file);
```

### Драйверы ↔ Аппаратура
```c
// VGA вывод
vga_print("Hello LakOS\n");

// Чтение с диска
ata_read(sector, buffer, count);
```

## 🎯 Архитектурные принципы

### 1. Минимализм
- Только необходимые компоненты
- Простые алгоритмы
- Минимальные зависимости

### 2. Образовательность
- Читаемый код
- Комментарии и документация
- Пошаговая инициализация

### 3. Модульность
- Четкое разделение ответственности
- Независимые драйверы
- Отдельные подсистемы

### 4. Портабельность
- Стандартные соглашения
- Минимальные зависимости от железа
- Чистый C код

## 🔍 Текущие ограничения

1. **Однопоточность** - Нет многозадачности
2. **Нет виртуальной памяти** - Прямое использование физической памяти
3. **Ограниченная файловая система** - Только чтение tar-архивов
4. **Нет защиты памяти** - Все компоненты в одном адресном пространстве
5. **Простой GUI** - Только базовые элементы интерфейса

## 🚀 Планы развития

1. **Многозадачность** - Добавление планировщика задач
2. **Виртуальная память** - Реализация paging
3. **Расширенная файловая система** - Поддержка записи
4. **Сетевые возможности** - Базовый сетевой стек
5. **Расширенный GUI** - Более сложный графический интерфейс

---

**Архитектура LakOS** - это баланс между простотой для обучения и функциональностью для практического использования.