# KERNEL.md - Устройство ядра LakOS

Этот документ описывает внутреннее устройство ядра операционной системы LakOS.

## 🧠 Архитектура ядра

LakOS использует **монолитное ядро** с четким разделением на подсистемы:

```
┌─────────────────────────────────────────┐
│              Пользовательские           │
│              программы (ELF)             │
├─────────────────────────────────────────┤
│              Shell                      │
├─────────────────────────────────────────┤
│              Ядро LakOS                 │
│  ┌─────────┬─────────┬─────────────────┐│
│  │ Драйверы│ Файловая │   Команды       ││
│  │ (VGA,   │ система  │   ядра          ││
│  │ клавиат.│ (tar-fs)│                 ││
│  └─────────┴─────────┴─────────────────┘│
├─────────────────────────────────────────┤
│              BIOS/GRUB                  │
└─────────────────────────────────────────┘
```

## 🏗️ Структура ядра

### Основные компоненты

#### 1. Загрузчик (boot/boot.asm)
**Функции:**
- Инициализация процессора в защищенном режиме
- Настройка базовых регистров сегментов
- Передача управления ядру
- Поддержка Multiboot стандарта

**Ключевые особенности:**
```asm
; Включение защищенного режима
mov eax, cr0
or eax, 1
mov cr0, eax

; Передача управления ядру
jmp 0x08:start
```

#### 2. Главная функция (kernel/kernel.c)
**Функции:**
- Инициализация подсистем ядра
- Запуск shell
- Обработка прерываний

**Последовательность инициализации:**
```c
void kmain(multiboot_info_t* mb_info, uint32_t magic) {
    // 1. Инициализация GDT
    init_gdt();
    
    // 2. Инициализация IDT
    idt_init();
    
    // 3. Установка обработчиков прерываний
    irq_install();
    
    // 4. Загрузка файловой системы
    tar_archive = (void*)&_binary_modules_tar_start;
    
    // 5. Инициализация драйверов
    ata_init();
    
    // 6. Запуск shell
    shell_main();
}
```

#### 3. Драйверы (kernel/drivers/)
**VGA драйвер (kernel/vga.c)**
- Цветной текстовый вывод
- Управление курсором
- Boot-анимация
- Системная информация

**Клавиатурный драйвер**
- Обработка скан-кодов
- Буфер ввода
- Специальные клавиши (Backspace, Enter, Escape)

**ATA драйвер (kernel/drivers/ata.c)**
- Чтение с диска
- Базовый DMA
- Поддержка LBA адресации

**Мышь (kernel/drivers/mouse.c)**
- PS/2 протокол
- Координаты и кнопки
- Буфер событий

#### 4. Файловая система (kernel/fs/tar.c)
**Tar-FS**
- Чтение tar-архивов как файловой системы
- Вшитый в образ modules.tar
- Поддержка каталогов и файлов
- Поиск по имени

**Ключевые функции:**
```c
// Поиск файла в архиве
void* tar_lookup(void* archive, const char* filename);

// Получение размера файла
int tar_get_file_size(void* archive, const char* filename);

// Проверка существования пути
int tar_check_path_exists(void* archive, const char* path);
```

#### 5. Shell (kernel/shell.c)
**Функции:**
- Командный интерпретатор
- История команд
- Автодополнение
- Выполнение ELF-программ
- Перенаправление ввода/вывода

#### 6. Команды ядра (kernel/commands.c)
**Встроенные команды:**
- `ls`, `cd`, `pwd` - навигация
- `cat`, `echo` - работа с файлами
- `users`, `login` - управление пользователями
- `gui` - запуск графического интерфейса

#### 7. GUI (kernel/gui.c)
**Примитивный графический интерфейс:**
- Окна и виджеты
- Обработка событий мыши
- Простая графика

## 🔧 Подсистемы ядра

### 1. Управление памятью

#### Структура памяти
```
0x00000000 ┌─────────────────┐
           │    Нижняя       │
           │    память       │
0x00100000 ├─────────────────┤ ← 1MB
           │     Ядро        │
           │   (lakos.bin)   │
0x00200000 ├─────────────────┤ ← 2MB
           │   RootFS        │
           │ (modules.tar)   │
0x00400000 ├─────────────────┤ ← 4MB
           │   Свободная     │
           │    память       │
           │   (для malloc)  │
0xFFFFFFFF └─────────────────┘
```

#### Функции управления памятью
```c
// Простое выделение памяти
void* malloc(size_t size);
void free(void* ptr);

// Работа с памятью
void* memcpy(void* dest, const void* src, size_t n);
void* memset(void* s, int c, size_t n);
```

### 2. Управление процессами

**Текущее состояние:**
- Однопоточность
- Нет многозадачности
- Простой цикл обработки команд

**Планы развития:**
- Добавление планировщика задач
- Реализация контекстного переключения
- Поддержка приоритетов

### 3. Система прерываний

#### IDT (Interrupt Descriptor Table)
```c
// Инициализация IDT
void idt_init(void);

// Установка обработчика прерывания
void set_idt_entry(int vector, uint32_t handler, uint16_t sel, uint8_t flags);
```

#### Обработчики прерываний
```c
// Обработчик клавиатуры
void keyboard_handler(void);

// Обработчик таймера
void timer_handler(void);

// Обработчик системных вызовов
void syscall_handler(int syscall_num, int arg1, int arg2, int arg3);
```

### 4. Системные вызовы

**Текущая реализация:**
- Минимальный набор системных вызовов
- Прямой вызов функций ядра

**Планы развития:**
- Расширенный набор системных вызовов
- Защита памяти
- Проверка прав доступа

### 5. Управление пользователями

#### Структура пользователя
```c
typedef struct {
    char username[32];
    char password[32];
    int uid;
    int gid;
} user_t;
```

#### Функции управления
```c
// Аутентификация пользователя
int authenticate_user(const char* username, const char* password);

// Добавление пользователя
int add_user(const char* username, const char* password);

// Удаление пользователя
int delete_user(const char* username);

// Получение текущего пользователя
int get_current_uid(void);
int get_current_gid(void);
```

## 🔄 Взаимодействие компонентов

### Shell ↔ Команды ядра
```c
// Вызов встроенной команды
int result = cmd_ls(argc, argv);

// Выполнение ELF-программы
int result = execute_elf("/bin/program");
```

### Shell ↔ Файловая система
```c
// Чтение файла
file_t* file = tarfs_open("/etc/config.txt");
char* content = tarfs_read(file);
tarfs_close(file);
```

### Драйверы ↔ Аппаратура
```c
// VGA вывод
vga_print("Hello LakOS\n");

// Чтение с диска
ata_read(sector, buffer, count);
```

## 🎯 Архитектурные принципы

### 1. Минимализм
- Только необходимые компоненты
- Простые алгоритмы
- Минимальные зависимости

### 2. Образовательность
- Читаемый код
- Комментарии и документация
- Пошаговая инициализация

### 3. Модульность
- Четкое разделение ответственности
- Независимые драйверы
- Отдельные подсистемы

### 4. Портабельность
- Стандартные соглашения
- Минимальные зависимости от железа
- Чистый C код

## 🔍 Текущие ограничения

### 1. Однопоточность
**Проблема:** Нет многозадачности
**Решение:** Добавление планировщика задач

### 2. Нет виртуальной памяти
**Проблема:** Прямое использование физической памяти
**Решение:** Реализация paging

### 3. Ограниченная файловая система
**Проблема:** Только чтение tar-архивов
**Решение:** Поддержка записи и других форматов

### 4. Нет защиты памяти
**Проблема:** Все компоненты в одном адресном пространстве
**Решение:** Разделение пространств

### 5. Простой GUI
**Проблема:** Только базовые элементы интерфейса
**Решение:** Расширенный графический интерфейс

## 🚀 Планы развития

### 1. Многозадачность
```c
// Планировщик задач
typedef struct {
    uint32_t* stack;
    uint32_t eip;
    uint32_t esp;
    int priority;
    int state;
} task_t;

void schedule(void);
void task_switch(void);
```

### 2. Виртуальная память
```c
// Страницы памяти
typedef struct {
    uint32_t present : 1;
    uint32_t writable : 1;
    uint32_t user : 1;
    uint32_t accessed : 1;
    uint32_t dirty : 1;
    uint32_t unused : 7;
    uint32_t frame : 20;
} page_t;
```

### 3. Расширенная файловая система
```c
// Новые типы файловых систем
typedef struct {
    const char* name;
    int (*mount)(void);
    int (*read)(file_t* file, void* buffer, size_t size);
    int (*write)(file_t* file, const void* buffer, size_t size);
} fs_driver_t;
```

### 4. Сетевые возможности
```c
// Сетевой стек
typedef struct {
    uint8_t mac[6];
    uint32_t ip;
    uint16_t port;
} network_interface_t;
```

### 5. Расширенный GUI
```c
// Графические элементы
typedef struct {
    int x, y, width, height;
    char* text;
    void (*on_click)(void);
} widget_t;
```

## 📊 Производительность

### Текущие характеристики
- **Размер ядра:** ~100KB
- **Время загрузки:** ~3 секунды
- **Потребление памяти:** ~2MB
- **Поддерживаемые устройства:** ATA, PS/2, VGA

### Оптимизации
- Минимальное использование памяти
- Простые алгоритмы
- Отсутствие избыточных абстракций

## 🔒 Безопасность

### Текущая безопасность
- Проверка прав пользователей
- Ограничение доступа к системным функциям
- Проверка входных данных

### Планы по безопасности
- Разделение привилегий
- Защита памяти
- Контроль доступа

---

**Ядро LakOS** - это баланс между простотой для обучения и функциональностью для практического использования.